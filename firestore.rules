/**
 * Core Philosophy: This ruleset implements a role-based access control (RBAC) model
 * for the AttendanceEase application. Authorization is determined by a user's
 * existence in either the `/admins` or `/users` collection. Admins have broad
 * management capabilities over core data like courses, students, and user roles.
 * Designated 'Users' have the specific permission to mark attendance.
 *
 * Data Structure: The structure separates roles and data entities into distinct
 * top-level collections: `/admins`, `/users`, `/students`, and `/courses`.
 * Course-specific data, such as enrollments (`/students`) and `attendance_records`,
 * are nested within their parent `/courses/{courseId}` document. This hierarchical
 * layout enables intuitive, path-based security and performant queries.
 *
 * Key Security Decisions:
 * - Admin-Managed System: Admins are responsible for creating and managing all
 *   foundational data, including courses, students, and user accounts.
 * - Role-Based Authorization: Instead of custom claims, a user's role is determined
 *   by the existence of their UID as a document ID in `/admins` or `/users`. This
 *   is a scalable and easily managed approach.
 * - Restricted Data Listing: The list of admins and users is not publicly readable
 *   to prevent user enumeration attacks.
 * - Granular Permissions: 'Users' can create attendance records, but only 'Admins'
 *   can modify or delete them, ensuring data integrity and providing an audit trail.
 *
 * Denormalization for Authorization: This ruleset relies on path-based security.
 * By nesting attendance records under a specific course (`/courses/{courseId}/...`),
 * we can easily validate that new records belong to the correct course without
 * needing extra `get()` calls. Further, new attendance records require a `markedBy`
 * field matching the creator's UID, denormalizing ownership directly onto the record
 * for simple and secure validation.
 *
 * Structural Segregation: The system segregates users by role into distinct
 * collections (`/admins` and `/users`). This provides a clear, secure, and
 * performant way to check roles using `exists()` calls, which is superior to
 * managing roles within a single, large users collection.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user is an administrator by verifying
     * the existence of their user UID in the /admins collection.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    /**
     * Checks if the currently authenticated user has the 'user' role, which grants
     * permission to mark attendance. This is verified by checking for their
     * user UID in the /users collection.
     */
    function isUser() {
      return isSignedIn() && exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    /**
     * Checks if the user is either an Admin or a User. This role is used for
     * read access to shared data like courses and students.
     */
    function isAttendanceMarker() {
      return isAdmin() || isUser();
    }

    /**
     * Checks if the currently authenticated user's UID matches the provided docId.
     * This is the standard pattern for verifying document ownership.
     */
    function isOwner(docId) {
      return isSignedIn() && request.auth.uid == docId;
    }

    /**
     * Ensures that a document being updated or deleted actually exists.
     * This prevents write operations on non-existent paths.
     */
    function isExistingDoc() {
      return resource != null;
    }

    // --------------------------------------------------------------------
    // Collection Rules
    // --------------------------------------------------------------------

    /**
     * @description Admin profiles. Admins can create other admins and update their own profiles.
     * @path /admins/{adminId}
     * @allow (create) An existing admin creates a new admin document. auth.uid must be in /admins.
     * @allow (update) An admin updates their own profile document. auth.uid must match {adminId}.
     * @deny (list) A user attempts to list all admin documents.
     * @deny (delete) An admin attempts to delete their own document.
     * @principle Restricts access to a user's own data tree and enforces role-based creation.
     */
    match /admins/{adminId} {
      allow get: if isOwner(adminId);
      allow list: if false;
      allow create: if isAdmin() && request.resource.data.id == adminId;
      allow update: if isOwner(adminId) && request.resource.data.id == resource.data.id;
      allow delete: if isAdmin() && !isOwner(adminId) && isExistingDoc();
    }

    /**
     * @description Profiles for users who can mark attendance. Managed entirely by admins.
     * @path /users/{userId}
     * @allow (create) An admin creates a new user profile.
     * @allow (get) A user views their own profile, or an admin views any user profile.
     * @deny (list) An anonymous user attempts to list all users.
     * @deny (update) A user attempts to update their own profile.
     * @principle Enforces admin-only management for user roles and credentials.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if false;
      allow create: if isAdmin() && request.resource.data.id == userId;
      allow update: if isAdmin() && isExistingDoc() && request.resource.data.id == resource.data.id;
      allow delete: if isAdmin() && isExistingDoc();
    }

    /**
     * @description Student profiles. Managed by admins, but readable by any user who can mark attendance.
     * @path /students/{studentId}
     * @allow (create) An admin adds a new student to the system.
     * @allow (list) An attendance marker ('user' or 'admin') lists all students.
     * @deny (update) A 'user' (non-admin) tries to change a student's details.
     * @deny (delete) Anyone other than an admin tries to delete a student.
     * @principle Separates write permissions (admin-only) from read permissions (role-based).
     */
    match /students/{studentId} {
      allow get, list: if isAttendanceMarker();
      allow create: if isAdmin() && request.resource.data.id == studentId;
      allow update: if isAdmin() && isExistingDoc() && request.resource.data.id == resource.data.id;
      allow delete: if isAdmin() && isExistingDoc();
    }

    /**
     * @description Course information. Managed by admins, readable by attendance markers.
     * @path /courses/{courseId}
     * @allow (create) An admin creates a new course.
     * @allow (list) A user or admin lists all available courses.
     * @deny (update) A non-admin user attempts to change a course description.
     * @principle Separates write permissions (admin-only) from read permissions (role-based).
     */
    match /courses/{courseId} {
      allow get, list: if isAttendanceMarker();
      allow create: if isAdmin() && request.resource.data.id == courseId;
      allow update: if isAdmin() && isExistingDoc() && request.resource.data.id == resource.data.id;
      allow delete: if isAdmin() && isExistingDoc();

      /**
       * @description Represents student enrollment in a specific course. Managed by admins.
       * @path /courses/{courseId}/students/{studentId}
       * @allow (create) An admin enrolls a student in a course.
       * @allow (list) A user lists all students enrolled in a specific course.
       * @deny (create) A student tries to enroll themselves in a course.
       * @principle Validates relational integrity between parent and child documents.
       */
      match /students/{studentId} {
        allow get, list: if isAttendanceMarker();
        allow create: if isAdmin() && request.resource.data.courseId == courseId && request.resource.data.studentId == studentId;
        allow update: if isAdmin() && isExistingDoc() && request.resource.data.courseId == resource.data.courseId && request.resource.data.studentId == resource.data.studentId;
        allow delete: if isAdmin() && isExistingDoc();
      }

      /**
       * @description Attendance records for a course. Created by 'Users', managed by 'Admins'.
       * @path /courses/{courseId}/attendance_records/{attendanceRecordId}
       * @allow (create) A 'user' creates a new attendance record for a student in this course.
       * @allow (list) An admin lists all attendance records for a course to generate a report.
       * @deny (create) An admin tries to create an attendance record (must be a 'user').
       * @deny (update) A 'user' tries to change an attendance record after submitting it.
       * @principle Enforces creator ownership on create and restricts modification to higher-level roles.
       */
      match /attendance_records/{attendanceRecordId} {
        allow get, list: if isAttendanceMarker();
        allow create: if isUser() && request.resource.data.markedBy == request.auth.uid && request.resource.data.courseId == courseId;
        allow update: if isAdmin() && isExistingDoc() && request.resource.data.markedBy == resource.data.markedBy && request.resource.data.courseId == resource.data.courseId;
        allow delete: if isAdmin() && isExistingDoc();
      }
    }
  }
}